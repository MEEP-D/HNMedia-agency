<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta name="vercel-toolbar" content="false">
  <meta name="x-vercel-protection-bypass" content="1">
  <meta name="x-vercel-skip-sso" content="1">

  <title>CMS - HN Media Agency</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
</head>

<body>

  <!-- ✨ CHỈ load Decap CMS – KHÔNG manual init, KHÔNG CMS.init() -->
  <script src="/admin/decap-cms.js"></script>

  <div id="nc-root"></div>

  <!-- Panel hướng dẫn -->
  <div class="cms-help" style="position: fixed; right: 16px; bottom: 16px; z-index: 9999;">
    <div class="cms-help">
    <div id="cms-help-panel" class="cms-help-panel">
      <button id="cms-help-close" class="cms-help-close" title="Đóng" type="button">×</button>
      <div class="cms-help-title">Quy trình chỉnh sửa</div>
      <ol class="cms-help-list">
        <li>Vào mục "Nội dung trang" để sửa Trang chủ, Giới thiệu...</li>
        <li>Mỗi mục có phần mô tả và tóm tắt giúp bạn dễ định vị.</li>
        <li>Bấm "Save" để lưu, sau đó "Publish" để xuất bản.</li>
      </ol>
      <div class="cms-help-title" style="margin-top:8px;">Mẹo sử dụng</div>
      <ol class="cms-help-list">
        <li>Dùng các trường (EN) để nhập nội dung tiếng Anh.</li>
        <li>Trong "Sections", dùng loại "text" cho nội dung tự do.</li>
        <li>Hình ảnh nên đặt tên rõ ràng, dung lượng nhẹ.</li>
      </ol>
    </div>
  </div>
  </div>
  <script>
  (function () {
    // 1) Lấy token từ URL
    const params = new URLSearchParams(window.location.search);
    const token = params.get("token");

    if (token) {
      console.log("Saving OAuth token:", token);

      localStorage.setItem(
        "netlify-cms-user",
        JSON.stringify({
          token: token,
          backendName: "github",
          loginSource: "oauth",
          provider: "github"
        })
      );

      const cleanUrl = window.location.origin + window.location.pathname;
      window.history.replaceState({}, "", cleanUrl);
    }

    // 2) Khởi động CMS SAU khi script CMS load
    document.addEventListener("DOMContentLoaded", () => {
      if (window.CMS) {
        console.log("CMS loaded → Initializing...");
        window.CMS.init({
          config: '/admin/config.yml'
        });
      } else {
        console.error("CMS NOT LOADED — decap-cms.js failed to load");
      }
    });
  })();
  </script>

</body>
</html>
